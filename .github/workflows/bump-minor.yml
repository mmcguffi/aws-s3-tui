name: Bump minor version on main

on:
  push:
    branches:
      - main

jobs:
  bump-minor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for skip marker
        id: skip
        run: |
          msg="$(git log -1 --pretty=%B)"
          echo "message<<EOF" >> "$GITHUB_OUTPUT"
          echo "$msg" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          if echo "$msg" | grep -qiE '\[skip version\]|^chore: bump version'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump minor version
        id: bump
        if: steps.skip.outputs.skip != 'true'
        run: |
          python - <<'PY'
          import os
          import re
          import pathlib

          path = pathlib.Path("pyproject.toml")
          data = path.read_text()

          pattern = re.compile(r'^(version\s*=\s*")(\d+)\.(\d+)(")$', re.M)
          match = pattern.search(data)
          if not match:
            raise SystemExit("version not found in pyproject.toml")

          major = int(match.group(2))
          minor = int(match.group(3))
          new_version = f"{major}.{minor + 1}"

          new_data, count = pattern.subn(
            lambda m: f"{m.group(1)}{new_version}{m.group(4)}",
            data,
            count=1,
          )
          if count != 1:
            raise SystemExit("version replace failed")

          path.write_text(new_data)

          with open(os.environ["GITHUB_OUTPUT"], "a") as output:
            output.write(f"version={new_version}\n")

          print(f"bumped to {new_version}")
          PY

      - name: Commit and push
        if: steps.skip.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pyproject.toml
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }} [skip version]"
          git push

      - name: Set up Python
        if: steps.skip.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Build package
        if: steps.skip.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Publish to PyPI
        if: steps.skip.outputs.skip != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true

      - name: Create tag
        id: tag
        if: steps.skip.outputs.skip != 'true'
        run: |
          tag="${{ steps.bump.outputs.version }}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          git fetch --tags
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Tag $tag already exists."
            exit 0
          fi
          git tag -a "$tag" -m "Release $tag"
          git push origin "$tag"

      - name: Create GitHub release
        if: steps.skip.outputs.skip != 'true' && steps.tag.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          generate_release_notes: true
